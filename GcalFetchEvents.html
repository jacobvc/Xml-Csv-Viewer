<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<html>

<head>
  <link href="style.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script type="text/javascript" src="options.js"></script>
  <script type="text/javascript" src="table-create.js"></script>
  <script type="text/javascript" src="xml-convert.js"></script>
  <script type="text/javascript" src="../data.json"></script>
  <script>
    // Title and revision
    var title = 'Calendar Event Detail Viewer';
    var revision = '1.0';

    var revisionstring = title + ', Revision ' + revision;
    let noCsvHeader = false;

    var pageheadingSettings = 'pageheadingSettings';

    // Name of selected content
    var thisContent = '';

    /* The name of the (XML File) root object */
    var rootObject;

    /* Data from the file as named array objects. (In the case of CSV), the single
       object is the file base name.
     */
    let fileData = {};

    /* Column names in selected content */
    let contentColumns = [];

    function processGCal(events) {
      let objectElem = document.getElementById("id-object");
      let contentElem = document.getElementById("id-content");

      contentElem.replaceChildren([]);
      hideDataTable();
      fileData = {};

      events.forEach(event => {
        console.log(event.summary);
        eventjson = {};
        console.log(event.description);

        eventjson['summary'] = event.summary;
        if (!(eventjson['summary'] in fileData)) {
          fileData[eventjson['summary']] = [];
          contentColumns[eventjson['summary']] = [{ 'name': 'summary', 'text': 'summary' }];
          contentElem.add(new Option(eventjson['summary'], eventjson['summary']));
        }

        try {
          if ('date' in event.start) {
            eventjson['date'] = new Date(event.start.date).toLocaleDateString();
          }
          else {
            eventjson['date'] = new Date(event.start.dateTime).toLocaleDateString();
          }
          AddContentColumn(eventjson['summary'], 'date');
        }
        catch {
          console.log('Invalid date')
        }

        if ('description' in event) {
          try {
            var lines = event.description.split(/\n/);
            lines.forEach(line => {
              var parts = line.split(':');
              if (parts.length == 2) {
                eventjson[parts[0].trim()] = parts[1].trim();
                AddContentColumn(eventjson['summary'], parts[0].trim());
              }
              else if (event.description.trim().length > 0) {
                eventjson['description'] = event.description;
                AddContentColumn(eventjson['summary'], 'description');
              }
            });
          }
          catch {
          }
        }
        else {
          console.log('No description')
        }
        fileData[eventjson['summary']].push(eventjson);
      });

      populateColumnOptions(contentElem.value);
    }

    function AddContentColumn(content, column) {
      if (!(contentColumns[content].find(obj => obj['name'] === column))) {
        contentColumns[content].push({ 'name': column, 'text': column });
      }
    }

    // Options
    function populateFormatOptions(elemId) {
      var formElem = document.getElementById(elemId);
      populateOptions(formElem, tableOptions, 'fmt-', false,
        [nested, incomeExpense, subtotal, highlight]);
      overrideOptions(tableOptions, 'fmt-');
    }
    function getFormatOptions() {
      return getOptions(tableOptions, 'fmt-');
    }
    function populateColumnOptions(which, elemId) {
      hideDataTable();

      thisContent = which;
      var formElem = document.getElementById('id-columns');
      populateOptions(formElem, contentColumns[which], 'col-', true);
      overrideOptions(contentColumns[which], 'col-');
    }
    function getColumnOptions(which) {
      return getOptions(contentColumns[which], 'col-');
    }

    // Creating and displaying the table

    // Hide 'elemId' and go to print dialog, then unhide upon return
    function printHiding(elemId) {
      var elem = document.getElementById(elemId);
      elem.style = "display: none";
      print();
      elem.style = "display: block";
    }
    function showData(which, elem, format, columns, onClick) {
      hideDataform();
      thisContent = which;

      var dodate = document.getElementById('printed-on');
      elem.replaceChildren();
      if (thisContent) {
        try {
          var pageheadingInpElem = document.getElementById('pageheading');
          if (pageheadingInpElem.value.trim().length > 0) {
            var span = document.createElement("span");
            span.style = "display:flex";
            var pageheadingElem = document.createElement('h3');
            pageheadingElem.textContent = pageheadingInpElem.value.trim();
            span.appendChild(pageheadingElem);
            if (dodate.checked) {
              var printed = document.createElement('h3');
              printed.textContent = "Printed on " + new Date().toLocaleDateString();
              printed.style = "margin-left: auto; display: inline-block";
              span.appendChild(printed);
            }
            elem.appendChild(span);
          }

          createTable(fileData[which], elem, which, columns,
            noCsvHeader, onClick, [], format);

          localStorage.setItem(pageheadingSettings, pageheadingInpElem.value.trim());
          localStorage.setItem('printdate', JSON.stringify(dodate.checked));
        } catch (error) {
          elem.textContent = 'Malformed file: ' + error.message;
        }
      }
      else {
        elem.textContent = 'No Content Selected';

      }
      showDataTable();
    };

    // Event handler (if onclick is specified in showData)
    function detailForm(src) {
      var formElem = document.getElementById("dataFormId");
      populateForm(src, thisContent, formElem);
      showDataform();
    }

    // Visibility
    function showDataform() {
      document.getElementById("id-data-form").style.display = "block";
    }
    function hideDataform() {
      document.getElementById("id-data-form").style.display = "none";
    }

    function showDataTable() {
      document.getElementById("id-data").style.display = "block";
    }
    function hideDataTable() {
      hideDataform();
      document.getElementById("id-data").style.display = "none";
    }

    // Form Load
    document.addEventListener('DOMContentLoaded', function () {
      hideDataform();
      populateFormatOptions('id-format');
      var elem = document.getElementById('pageheading');
      elem.value = localStorage.getItem(pageheadingSettings);

      elem = document.getElementById('printed-on');
      elem.checked = JSON.parse(localStorage.getItem('printdate'));

      elem = document.getElementById('title');
      elem.innerHTML = title;

      elem = document.getElementById('revision');
      elem.innerText = revisionstring;
    });

  </script>
  <style>
  </style>
</head>

<body>
  <div id="config">
    <h1><span id="title"></span>
      <span id="id-object"></span>
    </h1>

    <div id="config">
      <input type="button" onclick="processGCal(events)" value="Calendar events" />
      <label for=" id-content"> Content:</label>
      <select id="id-content" onchange="populateColumnOptions(this.value)"></select>

      <label for="printed-on"> Print Date</label>
      <input id="printed-on" type="checkbox" checked>

      <input type="button" onclick="printHiding('config')" value="Hide Configuration and Print" />
      <br>
      <span class='input-span'> Page Heading
        <input id="pageheading" size="60" type="text" />
      </span>
    </div>
    <p id="tooltip-text">The tooltip text.</p>
    <div class="group">Columns<br><button onclick="setAllOptions(contentColumns[thisContent], 'col-', true);">Select
        All</button>
      <div id="id-columns" class="container"></div>
    </div>
    
    <div class="group">Format
      <div id="id-format" class="container"></div>
    </div>
    <br>
    <input type="button" onclick="showData(
              document.getElementById('id-content').value,
              document.getElementById('id-data'), 
              getFormatOptions(), 
              getColumnOptions(document.getElementById('id-content').value),
              detailForm)" value="(re)Display)">
    <span id="revision" style="float:right"></span>
  </div>

  <form id="id-data-form" action="">
    <fieldset id="id-data-form">
      <div id="dataFormId"></div>
      <input style="padding: 6px; float: right" type="button" value="Close" onclick="hideDataform()">
    </fieldset>
  </form>
  <div id="id-data"></div>
</body>

</html>